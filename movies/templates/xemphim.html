{% extends "base.html" %}

{% block title %}Trang chủ{% endblock %}

{% block content %}
<div style="width:95vw; border-top:1px solid rgba(255, 255, 255, 0.152);margin-bottom: 2rem;;border-bottom:1px solid rgba(255, 255, 255, 0.152);padding: 0.5rem 0rem;">
    <a href="" style="text-decoration: none; color: rgb(196, 196, 196);">Trang chủ</a>
</div>
<iframe width="640" height="360"
        src="https://www.youtube.com/embed/{{movie.video_url}}"
        title="{{movie.title}}"
        frameborder="0"
        class="video"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen>
</iframe>
<div class="FULLHD" style="display:flex;witdh:88vw;justify-content:space-between;">
    <span>#FULL HD 1</span>
    <button class="btn-like" data-slug="{{ movie.slug }}">
    {% if is_liked %}
        <i class="bi bi-heart-fill"></i> Bỏ thích
    {% else %}
        <i class="bi bi-heart"></i> Thích
    {% endif %}
</button>
</div>

<div style="width: 93vw;margin-top: 2rem;">
    <div style="font-weight: 600; font-weight: 500;font-size: 1.3rem;color:white">Danh sách tập phim</div>
</div>
<div class="FULLHD" style="color: #000;font-weight: 500;">
    <span>FULL</span>
</div>
<div class="card" style="width: 93vw;margin-top: 2rem;">
  <div class="card-header">
    <h5>Để lại bình luận</h5>
  </div>
  <div class="card-body">
      {% for comment in comments %}
<div class="container-comment">
  <div class="d-flex align-items-start mb-3">
    <i class="fas fa-user-circle fa-3x me-3 text-secondary"></i>
    <div>
      <h6 class="mb-1">
        {{ comment.user.name }}
        <small class="text-muted">- {{ comment.created_at|date:"d/m/Y H:i" }}</small>
      </h6>
      <p class="mb-0">{{ comment.content }}</p>
    </div>
  </div>
  <hr>
</div>
{% endfor %}
    <form class="form-comment" action="/xemphim/{{movie.slug}}/comment" method="POST">
        {% csrf_token %}
      <div class="mb-3">
        <label for="comment" class="form-label">Bình luận</label>
        <textarea class="form-control" id="comment"  rows="4" name="comment" placeholder="Viết bình luận..."></textarea>
      </div>
      <button type="submit" class="btn btn-primary btn-submit" disabled>Gửi bình luận</button>
    </form>
  </div>
</div>
<div style="width: 93vw;margin-top: 2rem;">
    <div style="font-weight: 600; font-weight: 500;font-size: 1.3rem;color:white">Tóm tắt phim</div>
</div>
<div style="width: 93vw;margin-top:1rem;">
    <div style="font-weight: 600; font-weight: 500;font-size: 1rem; color: rgb(190, 190, 190);">{{movie.summary}}</div>
</div>
<div style="width: 93vw;margin-top:1rem;">
<h5 style="color: white; padding-bottom: 0.3rem; border-bottom: 3px solid orange;display: inline-block; font-weight: 600;margin-top: 2rem;">Có thể bạn cũng thích</h5>
</div>
<div style="width: 93vw;margin-top:1rem;">
<div class="multi-item-carousel">
  {% for movie in movies %}
  <div class="item">
  <a href="/xemphim/{{movie.slug}}" style="text-decoration: none;" class="achuaphim">
    <div class="card" style="width: 12rem; border:none;background-color:black">
      <img src="{{movie.poster_url}}" style="border-radius:0.5rem" class="card-img-top imghover" alt="...">
      <div class="HD">HD</div>
      <div class="vietsub">Vietsub</div>
      <div class="card-body">
        <p class="card-text" style="margin-top:-1rem; margin-left:-1rem;font-size:0.9rem;color:white; font-weight:500;">{{movie.title}}</p>
        <p class="card-text" style="margin-top:-1rem; margin-left:-1rem; color:gray;font-size:0.85rem;font-weight:500;">{{movie.titleE}}</p>
      </div>
    </div>
  </a>
  <i class="fa-solid fa-circle-play" style="color: #FFD43B;"></i>
</div>
{% endfor %}
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Like button functionality
    const likeButtons = document.querySelectorAll('.btn-like');

    likeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const slug = this.dataset.slug;
            const url = `/xemphim/${slug}/thich`;

            // Disable button để tránh spam click
            this.disabled = true;

            // Lấy CSRF token từ cookie
            function getCsrfToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        return value;
                    }
                }
                return '';
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    'action': 'toggle_like'
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateLikeButton(this, data.liked);
                } else {
                    console.log('Lỗi:', data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                // Enable lại button
                this.disabled = false;
            });
        });
    });

    // Hàm cập nhật giao diện button
    function updateLikeButton(button, isLiked) {
        if (isLiked) {
            button.innerHTML = '<i class="bi bi-heart-fill"></i> Bỏ thích';
        } else {
            button.innerHTML = '<i class="bi bi-heart"></i> Thích';
        }
    }

    // Comment functionality
    const textarea = document.getElementById("comment");
    const submitBtn = document.querySelector(".form-comment .btn-submit");
    if (textarea && submitBtn) {
        textarea.addEventListener("input", function () {
            submitBtn.disabled = textarea.value.trim().length === 0;
        });
    }
});
</script>

{% endblock %}